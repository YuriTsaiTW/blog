---
title: AC é—œéµå­—è¨ˆç•« | API é–‹ç™¼ã€æ¸¬è©¦ã€é™¤éŒ¯ä¸€æ¬¡åˆ°ä½ï¼ä½¿ç”¨ MSW å¿«é€Ÿä¸Šæ‰‹ Mock API
date: 2021-08-14 14:26:22
categories: è»Ÿé«”é–‹ç™¼
cover: /%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/cover.jpg
thumbnail: /%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/cover.jpg
tags: [API, MSW, JavaScript]
keywords: API, Mock API, Service Worker, MSW, JavaScript
comments: false
toc: true
---

æœ¬ç¯‡æ–‡ç« å·²åˆŠè¼‰åœ¨[AC Blog](https://tw.alphacamp.co/blog/learn-api-and-mock-service-worker)ã€‚

## ä»€éº¼æ˜¯ API

åœ¨èªè­˜ API ä»¥å‰ï¼Œæˆ‘å€‘ç›´æ¥å¾ç”Ÿæ´»ä¸­çš„ä¾‹å­ä¾†èªè­˜ä»‹é¢ (Interface)ã€‚

<!-- more -->

å¿™ç¢Œçš„åˆå¾Œï¼Œã€Œå°ç¾ã€æƒ³è¦å–ç½å¯çˆ¾å¿…æ€ã€‚æ–¼æ˜¯å¥¹å‰å¾€å…¬å¸æ¨“ä¸‹çš„é£²æ–™è²©è³£æ©Ÿï¼Œåœ¨ã€Œæ“ä½œé¢æ¿ä¸Šã€æŠ•ç¡¬å¹£è·ŸæŒ‰æŒ‰éˆ•ï¼Œè²©è³£æ©Ÿè£¡çš„ã€Œç³»çµ±ã€åˆ¤æ–·é‡‘é¡æ˜¯å¦ç¬¦åˆï¼Œä»¥åŠæ˜¯æŒ‰ä¸‹å“ªå€‹é£²æ–™çš„å°æ‡‰æŒ‰éˆ•ã€‚åˆ¤æ–·çµæŸå¾Œï¼Œå°±æŠŠä¸€ç½å¯çˆ¾å¿…æ€æ¨å‡ºä¾†ã€‚æœ€å¾Œå°ç¾å¾å–ç‰©å£æ‹¿å‡ºï¼Œå¤§å£åœ°æš¢é£²ã€‚

![](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/api.PNG)

åœ¨ä¸Šè¿°ä¾‹å­è£¡ï¼Œé£²æ–™è²©è³£æ©Ÿçš„æ§åˆ¶é¢æ¿å³ç‚ºäººæ©Ÿäº’å‹•çš„ã€Œä»‹é¢ã€ï¼Œä¹Ÿå°±æ˜¯ç­‰ä¸‹å¾…æœƒè¦è¬›çš„ã€ŒAPIã€ã€‚è€Œå°ç¾å‘¢ï¼Œå‰‡æ˜¯ä»‹é¢çš„ä½¿ç”¨è€…ï¼Œå°æ‡‰åˆ°è»Ÿé«”é–‹ç™¼çš„é ˜åŸŸä¸Šæ˜¯æŒ‡ API çš„ä½¿ç”¨è€…ï¼Œä¹Ÿå°±æ˜¯æˆ‘å€‘é€™äº›æ‡‰ç”¨ç¨‹å¼çš„é–‹ç™¼è€…ã€‚

APIï¼ˆApplication Programming Interfaceï¼‰çš„å­—é¢æ„æ€æ˜¯ã€Œæ‡‰ç”¨ç¨‹å¼ä»‹é¢ã€ã€‚å°±åƒé£²æ–™è²©è³£æ©Ÿçš„ä»‹é¢ä¸€æ¨£ï¼ŒAPI æ˜¯æ‡‰ç”¨ç¨‹å¼ä¹‹é–“ä¸€å¥—æ˜ç¢ºå®šç¾©çš„æºé€šæ–¹æ³•å’Œæ¥å£ã€‚ä½¿ç”¨ API çš„éç¨‹ä¸­ï¼Œä¸éœ€è¦ç†è§£å…§éƒ¨è¤‡é›œçš„é‹ä½œï¼Œåªéœ€è¦çŸ¥é“è¦å‘¼å«ä»€éº¼æ–¹æ³•ï¼Œå‚³å…¥å°æ‡‰åƒæ•¸ï¼Œå°±èƒ½å–å¾—æƒ³è¦çš„çµæœã€‚


### Web æ‡‰ç”¨ç¨‹å¼ä¸­çš„ API

åœ¨ Web æ‡‰ç”¨ç¨‹å¼çš„é–‹ç™¼æƒ…å¢ƒä¸‹çš„ API è¢«ç¨±ç‚º Web APIï¼Œåœ¨ Web API ä½œç”¨æ™‚ï¼Œå®¢æˆ¶ç«¯ï¼ˆå‰ç«¯ï¼‰å’Œä¼ºæœå™¨ç«¯ï¼ˆå¾Œç«¯ï¼‰æœƒé€é HTTP é€šè¨Šå”å®šä¾†é€²è¡Œè«‹æ±‚èˆ‡å›æ‡‰ã€‚

![åŸåœ–å–è‡ªï¼šAlphaCamp Blog](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/web-api.png)

ä½œç‚ºå‰ç«¯çš„é–‹ç™¼è€…ï¼Œç‚ºäº†è¦å–å¾—å­˜æ”¾åœ¨ç³»çµ±çš„è³‡è¨Šï¼Œå¸¸å¸¸æœƒéœ€è¦ä»¥ Web API ä¾†ç™¼é€è«‹æ±‚èˆ‡å¾Œç«¯æºé€šã€‚å› æ­¤é€šå¸¸éœ€è¦åšçš„äº‹æƒ…æœ‰ä»¥ä¸‹ï¼š
- é–±è®€ API æ–‡ä»¶
- å¦‚æœæ˜¯ç¬¬ä¸‰æ–¹é–‹ç™¼çš„æ‡‰ç”¨ï¼ˆä¾‹å¦‚ Googleã€Facebookï¼‰ï¼Œå¯èƒ½éœ€è¦è¨»å†Šã€é©—è­‰ç­‰ç¨‹åº
- æ’°å¯«æœ‰é—œ Web API ä¸²æ¥çš„å‡½å¼
- åœ¨é©ç•¶æ™‚æ©Ÿé»å‘¼å«å°æ‡‰çš„ä¸²æ¥å‡½å¼

è€Œå¾Œç«¯çš„é–‹ç™¼è€…ï¼Œå‰‡æ˜¯å°‡æ“æœ‰çš„è³‡æ–™åº«é–‹æ”¾çµ¦ç¬¬ä¸‰æ–¹ä½¿ç”¨ã€‚å› æ­¤é–‹ç™¼æ­¥é©Ÿå¤§è‡´æœƒæ˜¯é€™æ¨£ï¼š
- æ’°å¯«ä¸€å€‹æ˜ç¢ºçš„ API æ–‡ä»¶ï¼Œæ¸…æ¥šå®šç¾© API çš„ä½¿ç”¨æ–¹å¼åŠæ ¼å¼ç­‰ç­‰ã€‚
- æŒ‰ç…§æ–‡ä»¶é–‹ç™¼ä¸€å€‹ Web APIï¼Œæä¾›å¯å¤–éƒ¨å‘¼å«çš„æ–¹æ³•ï¼Œç”¨é€™å€‹æ–¹å¼åšç‚ºä½¿ç”¨ä»‹é¢ã€‚


### æ§åˆ¶ API çš„å›å‚³çµæœï¼Œå¯èƒ½å—ï¼Ÿ

å‰ç«¯é–‹ç™¼æ™‚ï¼Œåä¹‹å…«ä¹éƒ½æœƒéœ€è¦å¯¦ä½œ API çš„ä¸²æ¥ã€‚ä½ å¯èƒ½æœƒå…ˆå»ºç«‹ç›¸é—œçš„å‡½å¼æ¨¡çµ„ï¼Œç„¶å¾Œåœ¨å…ƒä»¶æˆ–æ˜¯ç‹€æ…‹ç®¡ç†çš„ç¨‹å¼ç¢¼ä¸­åŒ¯å…¥ï¼Œåœ¨é©ç•¶æ™‚æ©Ÿé»ç™¼å‡º API çš„è«‹æ±‚ã€‚

å•é¡Œä¾†äº†ï¼Œå¦‚æœæƒ³è¦æ¸¬è©¦ API å›å‚³ä¸åŒçš„çµæœä¸‹ï¼Œå…ƒä»¶çš„æ“ä½œé‚è¼¯æ˜¯å¦æ­£å¸¸ï¼›æˆ–æ˜¯ç¾åœ¨æ­£è™•æ–¼é››å‹ï¼ˆPrototypeï¼‰é–‹ç™¼çš„éšæ®µï¼Œåœ¨å¾Œç«¯çš„ Web API é‚„æ²’å®Œæˆçš„æƒ…æ³ä¸‹ï¼Œå‰ç«¯è¦è¶…å‰éƒ¨ç½²ç”¢å‡ºå…·é«”çš„åŠæˆå“ç­‰ï¼Œå‰ç«¯é€™é‚Šæ˜¯ä¸æ˜¯å¯ä»¥å…ˆå¯¦ä½œå¥½ API ä¸²æ¥çš„éƒ¨åˆ†ï¼Œè€Œä¸”é‚„èƒ½éš¨æ„æ§åˆ¶ API å›å‚³çš„çµæœå‘¢ï¼Ÿ

èˆ‰å€‹ç°¡å–®çš„ä¾‹å­ï¼Œåœ¨ `api.js` ä¸­ï¼Œå®šç¾©äº†æ‰€æœ‰è·Ÿ API ä¸²æ¥çš„å‡½å¼æ¨¡çµ„ï¼Œå…¶ä¸­ï¼Œ`isLoggedIn` å‡½å¼æ˜¯æª¢æŸ¥ä½¿ç”¨è€…æ˜¯å¦å·²ç™»å…¥ã€‚

- api.js

```javascript
export async function isLoggedIn() {
  axios.post("/api/account/isLoggedIn")
  .then(response => {
      // ...
  });
}
// ...
```
åœ¨å…ƒä»¶ï¼ `App.js` ä¸­ï¼Œæˆ‘å€‘åŒ¯å…¥`isLoggedIn` å‡½å¼ï¼Œä¸¦ä¸”åœ¨é©ç•¶æ™‚æ©Ÿé»å‘¼å«å®ƒï¼Œå¦‚æœå·²ç¶“ç™»å…¥ï¼ŒåŸ·è¡Œ Aï¼Œå¦å‰‡åŸ·è¡Œ Bã€‚

- App.js

```javascript
import { isLoggedIn } from './api';

function App() {
    //...
    await function initApp() {
        const isLoggedIn = await isLoggedIn();
        if(isLoggedIn) {
            // åš A äº‹...
        } else {
            // åš B äº‹...
        }
        
    }
    //...
    React.useEffect(() => {
        initApp();
    }, []);
    //...
}
```

å‡è¨­ä¸è®Šå‹• `App.js` ä¸­çš„ï¼    

``` javascript
const isLoggedIn = await isLoggedIn();
```
æˆ‘å€‘æœ‰è¾¦æ³•ç”±å‰ç«¯æ§åˆ¶ `isLoggedIn` è®Šæ•¸æ˜¯ `true` é‚„æ˜¯ `false`ï¼Œä¾†æª¢æŸ¥ç›¸é—œçš„æ¢ä»¶åˆ¤æ–·å—ï¼Ÿ

é€™å€‹å•é¡Œï¼Œç•¶ç„¶æ˜¯ YES å›‰ï¼é€™å°±æ˜¯ä»Šå¤©è¦è¬›çš„ï¼**Mock API**ã€‚

## API é–‹ç™¼ã€æ¸¬è©¦ã€é™¤éŒ¯ä¸€æ¬¡åˆ°ä½ï¼Mock API

å…ˆä¾†èªªæ–‡è§£å­—ä¸€ä¸‹ï¼Œã€ŒMockã€æ˜¯å¾å–®å…ƒæ¸¬è©¦çš„æ¦‚å¿µå»¶ä¼¸è€Œä¾†çš„ï¼Œä¸»è¦æ˜¯æ¨¡æ“¬çœŸå¯¦çš„ç‰©ä»¶æˆ–é¡åˆ¥ï¼Œä½†æ˜¯çœç•¥å…§éƒ¨è¤‡é›œçš„è¡Œç‚ºï¼Œè®“æ¸¬è©¦éç¨‹å¯ä»¥æ›´å°ˆæ³¨åœ¨æœ¬èº«çš„æ¸¬è©¦é‡é»ä¸Šã€‚

![åŸåœ–å–è‡ªï¼šç¨‹å¼æœ­è¨˜](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/mock.PNG)

åŒæ¨£åœ°ï¼Œæ¯”èµ·é€éçœŸå¯¦çš„å¾Œç«¯ server å–å¾—è³‡æ–™ï¼Œæˆ‘å€‘æœ‰æ™‚å€™æœƒæ¯”è¼ƒæƒ³è¦è‡ªå·±æ±ºå®šè³‡æ–™çš„æ¨£å­ï¼Œç”šè‡³æ˜¯å®šç¾© API çš„å…¥å£é»ï¼ˆentrypointï¼‰å’Œåƒæ•¸æ¬„ä½ç­‰ç­‰ï¼Œä½†åŒæ™‚åˆä¸æƒ³è®Šå‹•å‰ç«¯å‘¼å« API ä¸²æ¥çš„éƒ¨åˆ†ã€‚å¯ä»¥å®Œæˆä»¥ä¸Šç¨®ç¨®è¡Œç‚ºçš„æ–¹å¼ï¼Œå°±æ˜¯ Mock APIã€‚

### ä½¿ç”¨ Mock API çš„ç†ç”±

æœ€æ™®éçš„ä½¿ç”¨éœ€æ±‚ï¼Œæ‡‰è©²å°±æ˜¯å¸Œæœ›åœ¨åˆæœŸçš„é–‹ç™¼éšæ®µï¼Œå‰ç«¯ä¸éœ€è¦ç­‰å¾Œç«¯å¯¦ä½œå®Œæˆå¾Œæ‰èƒ½æ¥è‘—é€²è¡Œã€‚é™¤äº†è®“é–‹ç™¼æ™‚ç¨‹ä¸ç”¨èŠ±åˆ°é›™å€çš„æ™‚é–“ï¼Œå‰å¾Œç«¯é›™æ–¹ä¹Ÿèƒ½é€é Mock API çš„éç¨‹æ›´å…·é«”è¨è«–å¯¦ä½œç´°ç¯€ï¼Œé”æˆå“è³ªèˆ‡é€Ÿåº¦éƒ½èƒ½é›™è´çš„ç›®çš„ ğŸ’ª

é™¤æ­¤ä¹‹å¤–ï¼Œä»¥ä¸‹çš„å ´åˆä¹Ÿèƒ½æ‡‰ç”¨ Mock API ä¾†å®Œæˆï¼š

- æ’°å¯«æ¸¬è©¦æ¡ˆä¾‹ï¼šé€²è¡Œå…ƒä»¶æ¸¬è©¦æˆ– E2E æ¸¬è©¦æ™‚ï¼Œå¯ä»¥æ’°å¯«å„ç¨® HTTP ç‹€æ…‹ï¼Œæˆ–æ˜¯ä¸åŒå›æ‡‰è³‡æ–™æ™‚çš„æ¸¬è©¦æ¡ˆä¾‹ã€‚
- é–‹ç™¼æ™‚çš„é™¤éŒ¯ï¼šè—‰ç”±ä¿®æ”¹ mocking çš„å…§å®¹ï¼Œå¹«åŠ©å…ƒä»¶æˆ–é é¢é€²è¡Œé™¤éŒ¯ã€‚

![æœ‰æ²’æœ‰ mock API çš„æ™‚ç¨‹èˆ‡å“è³ªæ¯”è¼ƒ](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/compare.PNG)

## å‘ MSW Say Hiï¼

![åŸåœ–å–è‡ªï¼šMock Service Worker](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/msw.png)

MSWï¼ˆMock Service Workerï¼‰æ˜¯ä¸€å¥—å¯ä»¥å¯¦ç¾ Mock API çš„å·¥å…·ã€‚æœ€å¤§çš„ç‰¹è‰²æ˜¯èƒ½åœ¨ç¶²è·¯å±¤ï¼ˆNetworkï¼‰ç™¼å‡ºå¯¦éš›çš„è«‹æ±‚ï¼ˆRequestï¼‰ï¼Œä¸¦é€é Service Worker æ””æˆªï¼Œå›å‚³å·²ç¶“å®šç¾©å¥½çš„è³‡æ–™å…§å®¹ã€‚

å¦å¤–ï¼ŒMSW ä¹Ÿæ“æœ‰è¨±å¤šå„ªé»ï¼Œåƒæ˜¯ï¼š

- è·Ÿè¨±å¤šæ¡†æ¶ã€å·¥å…·éƒ½æœ‰å¾ˆå¥½çš„æ•´åˆæ€§ï¼Œåƒæ˜¯ Reactã€Jestã€Cypress ç­‰ã€‚
- é‡å°ä¸»æµçš„ API è¨­è¨ˆï¼RESTful å’Œ GraphQL éƒ½æœ‰è‰¯å¥½çš„æ”¯æ´ã€‚
- å¦‚æœå°ˆæ¡ˆæ˜¯ä»¥ TypeScript é–‹ç™¼ï¼Œä¸é ˆç‰¹åˆ¥è¨­å®šå°±èƒ½ç›´æ¥ä½¿ç”¨ TypeScriptï¼Œäº«å—å¼·å‹åˆ¥å¸¶ä¾†çš„ä¾¿åˆ©èˆ‡å¥½è™•ã€‚
- æ¸…æ¥šå¥½é–±è®€çš„å®˜æ–¹æ–‡ä»¶ï¼Œä¸¦ä¸”æœ‰ç¯„ä¾‹ç¨‹å¼ï¼Œè®“é–‹ç™¼è€…èƒ½å¥½ä¸Šæ‰‹ã€‚

å› æ­¤è·Ÿå…¶ä»–ç›¸ä¼¼çš„å·¥å…·ä¾†æ¯”è¼ƒï¼Œåƒæ˜¯ MirageJSã€json-serverï¼ŒMSW çš„ä¸‹è¼‰ä½¿ç”¨é‡å¹³å‡è¶…éå®ƒå€‘çš„å…©å€ï¼Œä¸¦ä¸”æœ‰æˆé•·çš„è¶¨å‹¢ã€‚é€™ä¹Ÿè¡¨ç¤ºç›¸é—œçš„ç¤¾ç¾¤è³‡æºå’Œè¨è«–è²é‡ä¹Ÿæœƒæ„ˆä¾†æ„ˆè±å¯Œã€‚

![åŸåœ–å–è‡ªï¼šnpm trends](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/trends.png)

åœ¨ç†Ÿæ‚‰ MSW ä¹‹å‰ï¼Œæˆ‘å€‘å…ˆåŸºç¤èªè­˜å®ƒçš„åº•å±¤æ©Ÿåˆ¶ï¼Service Workerï¼Œä»¥åŠçŸ¥é“ RESTful å’Œ GraphQL çš„å·®åˆ¥ã€‚

### Service Worker

Service Worker æ˜¯ Web Worker çš„ä¸€ç¨®ã€‚é™¤äº†å¯ä»¥åœ¨èƒŒæ™¯åŸ·è¡Œç·’ä¸­é‹ä½œï¼Œä¸å½±éŸ¿ä½¿ç”¨è€…çš„ç¶²é ç€è¦½é«”é©—ä»¥å¤–ï¼Œæœ€å¤§ç‰¹è‰²æ˜¯é€é cache çš„æ©Ÿåˆ¶ä¾†æ‰“é€ é›¢ç·šé«”é©—ã€‚æˆ‘å€‘å¤šå°‘æœƒç¢°åˆ°ä¸€äº›ç¶²ç«™æä¾›æ¨æ’­é€šçŸ¥ã€æš«å­˜è³‡æ–™æˆ–æ˜¯èƒŒæ™¯ä¸­åŒæ­¥ç­‰åŠŸèƒ½ï¼Œé€™è¦å¤šè™§æœ‰ Service Worker çš„å¯¦ç¾ã€‚

![åŸåœ–å–è‡ªï¼šnetlify](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/sw.png)

å°å…¥ Service Worker æœ‰å¹¾å€‹é‡é»æ­¥é©Ÿï¼š

1. æª¢æŸ¥ç€è¦½å™¨çš„æ”¯æ´åº¦ï¼šåŸºæœ¬ä¸Šé™¤äº†IEï¼Œå¤§éƒ¨åˆ†ç€è¦½å™¨åœ¨æŸç‰ˆæœ¬ä¹‹å¾Œéƒ½æœ‰é™¸çºŒæ”¯æ´ï¼Œå¦‚æœéœ€è¦ï¼Œå¯ä»¥åŠ ä¸Šæª¢æŸ¥ã€‚

```javascript
if ('serviceWorker' in navigator) {
    // ...
}
```
2. è¨»å†Šï¼šå‘¼å«å…¨åŸŸæ–¹æ³• `navigator.serviceWorker.register()` é€²è¡Œè¨»å†Šã€‚ç”±æ–¼é€™æ˜¯å€‹ promise å‡½å¼ï¼Œå¯ä»¥é€é `then` è·Ÿ `catch` ä¾†åšå®Œæˆå¾Œçš„è™•ç†ã€‚

```javascript
navigator.serviceWorker.register('/serviceWorker.js')
    .then(register => {})
    .catch(error => {});
```

3. å®‰è£ï¼šè¨»å†Šå®Œå¾Œï¼Œæœƒè§¸ç™¼ `serviceWorker.js` ä¸­çš„ `install` äº‹ä»¶ï¼ŒåŸ·è¡Œç€è¦½å™¨çš„é›¢ç·šå¿«å–åŠŸèƒ½ã€‚

``` javascript
this.addEventListener('install', function () {
  // ...
})
```
4. å•Ÿå‹•ï¼šè¨»å†Šå®Œå¾Œï¼Œæœƒè§¸ç™¼ `serviceWorker.js` ä¸­çš„ `active` äº‹ä»¶ï¼Œæ­£å¼å•Ÿå‹• Service Workerã€‚

``` javascript
this.addEventListener('active', function () {
  // ...
})
```

5. å­˜å–è«‹æ±‚å…§å®¹ï¼šç•¶åœ¨é€™å€‹ Service Worker çš„å¯æ§ç¯„åœå…§åµæ¸¬åˆ° HTTP è«‹æ±‚ï¼Œæœƒè§¸ç™¼ `serviceWorker.js` ä¸­çš„ `fetch` äº‹ä»¶å¯¦ä½œ cache çš„æ©Ÿåˆ¶ã€‚

```javascript
this.addEventListener('fetch', async function (event) {
    // ...
}
```

6. æ”¶ç™¼è¨Šæ¯ï¼šè§¸ç™¼ `serviceWorker.js` ä¸­çš„ `message` äº‹ä»¶ï¼Œè™•ç†å„ç¨®è«‹æ±‚éšæ®µçš„æ¥æ”¶èˆ‡ç™¼é€è¨Šæ¯ã€‚

```javascript
this.addEventListener('message', function(e) {
  // ...
});
```

### RESTful vs. GraphQL

RESTful æ˜¯ä¸€ç¨® API çš„è¨­è¨ˆé¢¨æ ¼ï¼Œå°‡æœ‰èªæ„æ€§çš„è©å½™åŠ ä¸Šè³‡æ–™åƒæ•¸å½¢æˆç‰¹å®šè·¯ç”±ï¼ˆRouteï¼‰ï¼Œä¸¦é‹ç”¨ HTTP å„ç¨®å®šç¾©çš„è«‹æ±‚æ–¹å¼ï¼Œå‘å¾Œç«¯å–å¾—è³‡æºæˆ–æ˜¯ä¿®æ”¹è³‡æºã€‚

å› æ­¤ RESTful æœ€å¤§çš„ç‰¹é»æ˜¯ï¼Œå¯ä»¥é€éè·¯ç”±çš„çµæ§‹æ¸…æ¥šçŸ¥é“è³‡æ–™æ¬„ä½è·Ÿæ“ä½œæ–¹å¼ï¼Œé©åˆç”¨ä¾†è¨­è¨ˆç°¡å–®æˆ–æ˜¯çµæ§‹è¼ƒç‚ºå–®ç´”çš„ APIã€‚

![åŸåœ–å–è‡ªï¼šhow to graphql](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/rest.png)

GraphQL æ˜¯ç”± Facebook åœ¨ 2015 å¹´ç™¼å¸ƒçš„ open sourceã€‚é€éå‰ç«¯å®šç¾©çš„è³‡æ–™çµæ§‹ï¼Œå‘Šè¨´å¾Œç«¯è¿”å›ç›¸åŒè³‡æ–™çµæ§‹çš„å°æ‡‰è³‡æ–™ï¼Œä¾†é¿å…å¾Œç«¯è¨­è¨ˆå¤§é‡çš„ API route ï¼Œæˆ–æ˜¯è¿”å›å¤šé¤˜çš„è³‡æ–™æ¬„ä½ã€‚

ä¸éé€™ç¨®éˆæ´»æ€§ä¹Ÿå¢åŠ äº†è¤‡é›œæ€§ï¼Œé€šå¸¸æœƒæ¯”è¼ƒé©åˆç”¨ä¾†è¨­è¨ˆå…·è¦æ¨¡æˆ–æ˜¯çµæ§‹æ¯”è¼ƒäº¤éŒ¯è¤‡é›œçš„ APIã€‚

![åŸåœ–å–è‡ªï¼šhow to graphql](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/graphql.png)

## MSW åˆé«”é©—

å¦‚æœåªæ˜¯æƒ³å…ˆé«”é©—çœ‹çœ‹ï¼Œä¸ç”¨å¤§è²»å‘¨ç« å»ºç«‹ç’°å¢ƒï¼Œå¯ä»¥åƒè€ƒ[ MSW å»ºç«‹çš„ç¯„ä¾‹ç¨‹å¼](https://github.com/mswjs/examples)ï¼Œè£¡é¢æœ‰è¨±å¤šä¸åŒçš„ç¯„æœ¬å°ˆæ¡ˆã€‚åˆ‡åˆ°ä¸åŒçš„å°ˆæ¡ˆç’°å¢ƒå¾Œï¼Œå°±å¯ä»¥åŸ·è¡Œç›¸é—œæŒ‡ä»¤ç©ç©çœ‹å›‰ğŸ˜Š

1. clone ç¯„æœ¬å°ˆæ¡ˆã€‚åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œæˆ–æ˜¯ä½¿ç”¨ GitHub Desktop çš„ Clone Repository > URL è¼¸å…¥ä»¥ä¸‹çš„ç¶²å€éƒ¨åˆ†ã€‚

``` bash
git clone https://github.com/mswjs/examples.git
```

2. åˆ‡æ›åˆ° examples ç›®éŒ„ã€‚

``` bash
cd examples
```

3. å®‰è£æ‰€æœ‰ä¾è³´å¥—ä»¶ã€‚

``` bash
yarn
# or npm install
```

4. åˆ‡æ›åˆ°ç‰¹å®šç›®éŒ„ï¼Œä¾‹å¦‚ï¼šæƒ³çœ‹ä½¿ç”¨ Reactï¼ŒåŠ ä¸Š RESTful çš„ API è¨­è¨ˆæœƒæ˜¯ä»€éº¼æ¨£å­ï¼Œé‚£éº¼å°±åˆ‡æ›åˆ° `rest-react`ã€‚

``` bash
cd examples/rest-react
```

5. åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ï¼Œåœ¨æœ¬æ©Ÿå»ºç«‹ live serverã€‚

``` bash
yarn start
```

6. æ‰“é–‹ç€è¦½å™¨è¼¸å…¥ `localhost:3001`ã€‚æ­£å¸¸çš„è©±ï¼Œå¯ä»¥çœ‹åˆ°é é¢ä¸Šæœ‰å€‹ç°¡æ˜“è¡¨å–®ã€‚æŒ‰ F12 è§€å¯Ÿ consoleï¼Œå°±æœƒå‡ºç¾ [MSW] Mocking enabled.çš„è¨Šæ¯ï¼Œè¡¨ç¤º MSW å·²ç¶“åœ¨é‹ä½œå›‰ï¼

![ç¯„ä¾‹å°ˆæ¡ˆçš„èµ·å§‹é é¢](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/example-1.png)

7. å¯ä»¥æŠŠ Dev Tool åˆ‡åˆ° Network è§€å¯Ÿã€‚åœ¨è¡¨å–®æ¬„ä½éš¨æ„è¼¸å…¥å¾Œé€å‡ºï¼Œæœƒç™¼ç¾ Network ä¸­ç™¼å‡ºäº†ä¸€å€‹ login çš„è«‹æ±‚ã€‚

![Networkä¸­æ–°å¢äº†ä¸€å€‹loginè«‹æ±‚](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/example-2.png)

8. å†åˆ‡å› Consoleï¼Œå¯ä»¥çœ‹åˆ° MSW æœ‰å°å‡ºè«‹æ±‚çš„ Requestã€Reponse çš„è©³ç´°å…§å®¹ã€‚æ‰¾åˆ°ç¨‹å¼ç¢¼ä¾†å°ç…§çœ‹çœ‹ï¼Œçš„ç¢º MSW ç™¼æ®äº†ä½œç”¨ï¼Œä»¥ç¨‹å¼ä¸­å®šç¾©å¥½çš„è³‡æ–™ä½œç‚º Response çš„è³‡æ–™ï¼Œmagic~

![Consoleä¸­å°å‡ºäº†loginè«‹æ±‚çš„è©³ç´°å…§å®¹](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021081414/example-3.png)

## å»ºç½®èˆ‡å°å…¥ MSW

å¦‚æœæƒ³å¼•å…¥å°ˆæ¡ˆç’°å¢ƒä¸­ï¼Œå…¶å¯¦éå¸¸ç°¡å–®ï¼ŒåŸºæœ¬ä¸Šå®‰è£ msw é€™å€‹å¥—ä»¶å°±å¯ä»¥äº†ã€‚

```bash
yarn add -DW msw
# or npm i msw -D
```

ä¸éä¸å°‘äººï¼ŒåŒ…æ‹¬æˆ‘è‡ªå·±æ˜¯ç”¨ webpack ä¾†æ‰“åŒ…å‰ç«¯ç¨‹å¼å’Œå»ºç«‹ live serverã€‚å› æ­¤æ¥ä¸‹ä¾†çš„å»ºç½®æµç¨‹æœƒå†å¤šä»‹ç´¹ webpack çš„å°å…¥æ–¹å¼ã€‚


1. å®‰è£ MSW ä»¥åŠåŸ·è¡Œ webpack æ™‚æ‰€éœ€çš„ pluginsï¼Œä½œç‚ºé–‹ç™¼ç”¨çš„ä¾è³´å¥—ä»¶ã€‚

``` bash
yarn add -DW msw copy-webpack-plugin workbox-webpack-plugin
# or npm i msw copy-webpack-plugin workbox-webpack-plugin -D 
```

2. åœ¨å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ä¸‹å»ºç«‹ `public` çš„å­ç›®éŒ„ï¼Œå¦‚æœå·²ç¶“æœ‰çš„è©±çœç•¥ã€‚

3. åœ¨ `src` çš„ç›®éŒ„ä¸‹å»ºç«‹ `mocks` çš„å­ç›®éŒ„ã€‚

4. åœ¨ `mocks` çš„ç›®éŒ„ä¸‹å»ºç«‹å…©å€‹æª”æ¡ˆï¼ `handlers.ts(js)` ä»¥åŠ `browser.ts(js)`ï¼Œå¾…æœƒæœƒæåˆ°æ›´å¤šé€™å…©å€‹æª”æ¡ˆçš„å¯¦ä½œéƒ¨åˆ†ã€‚

5. åœ¨å°ˆæ¡ˆçš„æ ¹ç›®éŒ„ä¸‹é–‹å•Ÿçµ‚ç«¯æ©Ÿï¼ŒåŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤ä¾†å»ºç«‹è² è²¬ç”¢ç”Ÿ Service Worker çš„ç¨‹å¼æª” `mockServiceWorker.js`ã€‚å¦‚æœæœ‰èˆˆè¶£çš„è©±ï¼Œå¯ä»¥å¾é€™ä»½æª”æ¡ˆä¾†çœ‹ MSW å¦‚ä½•è¨­è¨ˆ Service Worker çš„æ¶æ§‹èˆ‡å„ç¨®ç”Ÿå‘½é€±æœŸçš„äº‹ä»¶å–”ï¼

```bash
npx msw init public/
```

6. åœ¨ `webpack.config.js` æˆ–ç‰¹å®šçš„ webpack è¨­å®šæª”ä¸­ï¼Œåœ¨ `plugins` éƒ¨åˆ†æ–°å¢è·Ÿ Service Worker ç›¸é—œçš„è¨­å®šã€‚
    - `CopyWebpackPlugin`ï¼ å°‡ `mockServiceWorker.js` è¤‡è£½åˆ° live server ä¸­ã€‚
    - `WorkboxPlugin`ï¼ å»ºç«‹ Service Workerã€‚

```javascript
const CopyWebpackPlugin = require('copy-webpack-plugin');
const WorkboxPlugin = require('workbox-webpack-plugin');

module.exports = {
    // ...

    plugins: [
        //...
        new CopyWebpackPlugin([
            { from: path.resolve(__dirname, './public', 'mockServiceWorker.js'), to: 'mockServiceWorker.js' },
        ]),
        new WorkboxPlugin.GenerateSW(),
    ]
}
```

7. åœ¨ `index.html` åµæ¸¬ç•¶å‰ç€è¦½å™¨æœ‰ç„¡æ”¯æ´ Service Workerï¼Œæœ‰çš„è©±å°±ä»¥ `mockServiceWorker.js` ä¾†è¨»å†Š Service Workerã€‚

```html
<script>
    // Check that service workers are supported
    if ('serviceWorker' in navigator) {
        // Use the window load event to keep the page load performant
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('/mockServiceWorker.js');
        });
    }
</script>
```

å¦‚æœæŒ‰ç…§ä»¥ä¸Šæ­¥é©Ÿåšå®Œçš„è©±ï¼Œç›®éŒ„çµæ§‹æ‡‰è©²æœƒé•·é€™æ¨£ï¼

```
-- MyProject/
   -- public/
      -- mockServiceWorker.js
   -- src/
      -- mocks/
         -- browser.ts(js)
         -- handlers.ts(js)
      -- index.html
   -- webpack.config.js
```

## å¿«é€Ÿä¸Šæ‰‹ MSW

`handlers.ts(js)` æ˜¯è² è²¬æ’°å¯« mock API çš„å¯¦ä½œç´°ç¯€ã€‚é€šå¸¸æœƒå»ºç«‹ä¸€å€‹é™£åˆ—è®Šæ•¸ï¼`handlers` ä¾†å­˜æ”¾å„å€‹ API ä¸²æ¥çš„å¯¦ä½œã€‚

``` javascript
export const handlers = [];
```

èˆ‰ä¸Šé¢ç¯„ä¾‹ç¨‹å¼çš„ login è«‹æ±‚ä½œç‚ºä¾‹å­ï¼Œåˆ†åˆ¥çœ‹çœ‹ RESTful è·Ÿ GraphQL é€™å…©ç¨® API è¨­è¨ˆæ¨¡å¼ï¼ŒMSW æœƒå¦‚ä½•å¯¦ä½œã€‚

### RESTful

å¾ msw åŒ¯å…¥ `rest`ã€‚`rest` æä¾›äº†å„ç¨®æ¨¡æ“¬ HTTP çš„è«‹æ±‚æ–¹å¼å¯¦ä½œï¼

  - `rest.get()`ï¼šå°æ‡‰ `GET` è«‹æ±‚ï¼Œå–å¾—è³‡æºã€‚
  - `rest.post()`ï¼šå°æ‡‰ `POST` è«‹æ±‚ï¼Œæäº¤æŒ‡å®šè³‡æºçš„å¯¦é«”ã€‚
  - `rest.put()`ï¼šå°æ‡‰ `PUT` è«‹æ±‚ï¼Œä¸Šå‚³æˆ–å–ä»£æŒ‡å®šçš„è³‡æºã€‚
  - `rest.patch()`ï¼šå°æ‡‰ `PATCH` è«‹æ±‚ï¼ŒæŒ‡å®šè³‡æºçš„éƒ¨ä»½ä¿®æ”¹ã€‚
  - `rest.delete()`ï¼šå°æ‡‰ `DELETE` è«‹æ±‚ï¼Œåˆªé™¤æŒ‡å®šè³‡æºã€‚
  - `rest.options()`ï¼šå°æ‡‰ `OPTIONS` è«‹æ±‚ï¼ŒæŸ¥è©¢ server æ”¯æ´çš„ HTTP è«‹æ±‚æ–¹å¼ã€‚

é€™äº›æ–¹æ³•éœ€è¦å›ºå®šå‚³å…¥å…©å€‹åƒæ•¸ï¼
  - **entrypoint**ï¼APIçš„è·¯å¾‘ï¼Œå¯ä»¥ `/:someData` çš„æ–¹å¼ä»¥è·¯å¾‘å‚³å…¥è³‡æ–™åƒæ•¸ã€‚
  - **resolver function**ï¼è«‹æ±‚å®Œæˆå¾Œçš„ resolve å‡½å¼ã€‚æœ‰ä¸‰å€‹åƒæ•¸å¯ä»¥æ“ä½œï¼Œåˆ†åˆ¥æ˜¯ï¼
    - `req`ï¼š`req.body` çš„ç‰©ä»¶å¯ä»¥å–å¾— Request body ä¸­çš„è³‡æ–™åƒæ•¸ã€‚
    - `res`ï¼šåŸ·è¡Œ `res()` ä¾†å›è¦†è«‹æ±‚ã€‚
    - `ctx`ï¼šåŸ·è¡Œ `ctx.json({...})` çµ„åˆå›å‚³çš„è³‡æ–™ï¼Œå®šç¾©æƒ³è¦çš„æ ¼å¼å’Œå…§å®¹ã€‚

```javascript
import { rest } from 'msw'

export const handlers = [
  rest.post('/login/:someData', (req, res, ctx) => {
    const { username } = req.body

    return res(
      ctx.json({
        id: 'f79e82e8-c34a-4dc7-a49e-9fadc0979fda',
        username,
        firstName: 'John',
        lastName: 'Maverick',
      })
    )
  }),
]
```

### GraphQL

å¾ msw åŒ¯å…¥ `graphql`ã€‚`graphql` å¯¦ä½œäº†å…©ç¨®æ“ä½œæ–¹å¼ï¼š

  - `graphql.query()`ï¼šå°æ‡‰ GraphQL çš„ `Query` ä¾†å®Œæˆè³‡æºçš„æŸ¥è©¢ã€‚
  - `graphql.mutation()`ï¼šå°æ‡‰ GraphQL çš„ `Mutation` ä¾†å®Œæˆè³‡æºæ–°å¢ã€åˆªé™¤ã€ä¿®æ”¹ç­‰æœƒç”¢ç”Ÿå‰¯ä½œç”¨çš„æ“ä½œã€‚

é€™äº›æ–¹æ³•éœ€è¦å›ºå®šå‚³å…¥å…©å€‹åƒæ•¸ï¼š
  - **name**ï¼å·²ç¶“å®šç¾©å¥½çš„ Query æˆ– Mutation åç¨±ã€‚
  - **resolver function**ï¼è«‹æ±‚å®Œæˆå¾Œçš„ resolve å‡½å¼ã€‚æœ‰ä¸‰å€‹åƒæ•¸å¯ä»¥æ“ä½œï¼Œåˆ†åˆ¥æ˜¯ï¼
    - `req`ï¼š`req.variables` çš„ç‰©ä»¶å¯ä»¥å–å¾— Request ä¸­çš„è³‡æ–™åƒæ•¸ã€‚
    - `res`ï¼šåŸ·è¡Œ `res()` ä¾†å›è¦†è«‹æ±‚ã€‚
    - `ctx`ï¼šåŸ·è¡Œ `ctx.data({...})` çµ„åˆå›å‚³çš„è³‡æ–™ï¼Œæ ¹æ“šå®šç¾©å¥½çš„æ¬„ä½æ ¼å¼ï¼Œè¨­è¨ˆæƒ³è¦çš„å…§å®¹ã€‚

```javascript
import { graphql } from 'msw'

export const handlers = [
  // Capture a "Login" mutation
  graphql.mutation('Login', (req, res, ctx) => {
    const { username } = req.variables

    return res(
      ctx.data({
        user: {
          username,
          id: 'f79e82e8-c34a-4dc7-a49e-9fadc0979fda',
          firstName: 'John',
          lastName: 'Maverick',
        },
      })
    )
  }),
]
```

ç•¶æˆ‘å€‘å¯«å¥½ handlers å¾Œï¼Œåœ¨ `browser.ts(js)` ä¸­å°±å¯ä»¥æ–°å¢è² è²¬åˆå§‹åŒ– MSW çš„è®Šæ•¸ï¼Œä¸¦ä¸”å‚³å…¥ handlers ä½œç‚ºåˆå§‹åŒ–çš„åƒæ•¸ï¼Œ è®“ MSW çŸ¥é“é‡åˆ°å“ªäº›è«‹æ±‚å¾Œè¦åŸ·è¡Œ mock API çš„å‹•ä½œã€‚

```javascript
import { setupWorker } from 'msw';
import { handlers } from './handlers'

// This configures a Service Worker with the given request handlers.
export const worker = setupWorker(...handlers);
```

é€šå¸¸æˆ‘å€‘æœƒåœ¨æœ¬æ©Ÿçš„é–‹ç™¼ç’°å¢ƒï¼Œæˆ–æ˜¯åŸ·è¡Œæ¸¬è©¦æ™‚ï¼Œæ‰æœƒå¸Œæœ›å•Ÿå‹• MSWã€‚å› æ­¤æˆ‘å€‘å¯ä»¥åœ¨ä¸»ç¨‹å¼çš„é€²å…¥é»åŠ ä¸Šç’°å¢ƒçš„æ¢ä»¶åˆ¤æ–·ã€‚

```javascript
import { worker } from './mocks/browser';

if (isTesting || process.env.NODE_ENV === 'development') {
    worker.start();
}
```

## å°çµ

é‡å°ä¸åŒå°ˆæ¡ˆæ‰¾å‡ºæœ€é©åˆçš„ API è¨­è¨ˆï¼Œä»¥åŠè®“å‰ç«¯å¯ä»¥åœ¨é¢å°å„ç¨®è³‡æ–™æƒ…æ³æ™‚ï¼Œéƒ½èƒ½æä¾›è‰¯å¥½çš„ä»‹é¢èˆ‡ç€è¦½é«”é©—ã€‚é€™äº›äº‹æƒ…éƒ½å¯ä»¥é€é Mock API çš„éç¨‹ä¸­å¯¦ç¾ã€‚å¸Œæœ›é€éä»Šå¤©çš„ä»‹ç´¹ï¼Œè®“å¤§å®¶å°æ–¼ Mock API æœ‰æ›´æ·±çš„äº†è§£ï¼Œä¸¦ä¸”æ„Ÿå— MSW æ“æœ‰çš„é­…åŠ›èˆ‡å¥½è™•ğŸ¥³

### Reference

- [APIæ˜¯ä»€éº¼ï¼Ÿèªè­˜ Web APIã€HTTP å’Œ JSON è³‡æ–™äº¤æ›æ ¼å¼](https://tw.alphacamp.co/blog/api-introduction-understand-web-api-http-json)
- [Service Worker](https://cythilya.github.io/2017/07/16/service-worker/)
- [ä»€éº¼æ˜¯REST? èªè­˜ RESTful API è·¯ç”±èªç¾©åŒ–è¨­è¨ˆé¢¨æ ¼](https://tw.alphacamp.co/blog/rest-restful-api)
- [GraphQL wiki](https://zh.wikipedia.org/wiki/GraphQL)
