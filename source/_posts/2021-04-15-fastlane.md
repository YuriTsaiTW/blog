---
title: è¡Œå‹•æ‡‰ç”¨ï½œè‡ªå‹•åŒ–é–‹ç™¼éšæ®µçš„æ›´ç‰ˆæµç¨‹ï½œfastlaneï½œconventional-changelog
date: 2021-04-15 14:26:22
categories: è»Ÿé«”é–‹ç™¼
cover: /%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/cover.png
thumbnail: /%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/cover.png
tags: [fastlane, React Native]
keywords: fastlane, dropbox, React Native, conventional-changelog
comments: false
toc: true
---

{% blockquote %}
Developers love writing React Native code but no one likes deploying React Native app or distributing beta builds. -<a href="https://thecodingmachine.github.io/react-native-boilerplate/docs/BetaBuild/"> RNBoilerplate Docs</a>
(é‚£äº›å–œæ„›å¯« React Native çš„é–‹ç™¼è€…ï¼Œä¸æœƒæœ‰äººå–œæ­¡åšå»ºç½®ã€ç™¼å¸ƒæˆ–ä¸Šæ¶çš„äº‹æƒ…)
{% endblockquote %}

<!-- more -->

## å‰è¨€

ç•¶å°ˆæ¡ˆé–‹ç™¼åˆ°äº†é››å‹éšæ®µæ™‚ï¼Œæœƒéœ€è¦è®“é–‹ç™¼äººå“¡ä»¥å¤–çš„äººä½¿ç”¨æˆ–æ¸¬è©¦ã€‚åœ¨ Web é–‹ç™¼ä¸­ï¼Œåªéœ€è¦æ›´æ–° server ä¸­çš„éœæ…‹æª”å°±èƒ½å®Œæˆï¼›ä½†æ˜¯åœ¨è¡Œå‹•æ‡‰ç”¨ä¸Šï¼Œå°±éœ€è¦å»ºç½®å‡ºå®‰è£æª”ï¼Œç•¶ä½¿ç”¨è€…ä¸‹è¼‰å®‰è£å¾Œï¼Œæ‰å®Œæˆæ›´ç‰ˆçš„å‹•ä½œã€‚

å¦‚æœå®Œå…¨ä¸é å·¥å…·å’ŒæŒ‡ä»¤ï¼Œæ¯æ¬¡å»ºç½®ã€ä¸Šå‚³æª”æ¡ˆç­‰éƒ½è¦ªåŠ›è€Œç‚ºï¼Œå…¶å¯¦èŠ±è²»ä¸å°‘æ™‚é–“ã€‚èˆ‰ä¾‹ä¾†èªªï¼Œåœ¨ XCode ä¸­ç”¢å‡ºå®‰è£æª” ipaï¼Œéœ€è¦ç¶“éä»¥ä¸‹æ­¥é©Ÿï¼š

1. é¸æ“‡è£ç½® `Any iOS Device`
2. `Product > Archive`ï¼Œé€šå¸¸æœƒç­‰ 2~3 åˆ†
3. åœ¨ Archives åˆ—è¡¨è¦–çª—ä¸­é»é¸ `Distribute app`
4. é¸æ“‡éƒ¨ç½²æ–¹å¼ã€‚ä¾‹å¦‚ `Enterprise`
5. é¸æ“‡ `Manually manage signing`
6. é¸æ“‡ `Distribution Certificate` & `Provision Profile`ï¼Œé€™æ™‚å€™æœƒå†ç­‰ 1~2 åˆ†
7. é»é¸ `Export`ï¼Œé¸æ“‡è¼¸å‡ºç›®éŒ„

åˆ°é€™è£¡å¤§æ¦‚å°±èŠ±äº†ç´„ 5 åˆ†é˜äº†ï¼Œæ¥è‘—é‚„éœ€è¦æ‰“é–‹ Dropboxï¼Œæˆ–æ˜¯è‡ªå®¶çš„ç©ºé–“ä¸Šå‚³å‰›å‰›å»ºç½®å‡ºçš„ ipaã€‚ç‚ºäº†çµ¦æ¸¬è©¦äººå“¡æŸ¥çœ‹æœ‰å“ªäº›æ›´æ–°ï¼Œé‚„è¦å†ç¶­è­·å®‰è£é ä¸­çš„è®Šæ›´ç´€éŒ„ã€‚æœ€å¾Œï¼Œéœ€è¦é€šçŸ¥æœ‰å®‰è£ App çš„äººå·²ç¶“æœ‰æ–°ç‰ˆé‡‹å‡ºã€‚

åšå®Œä¸€è¼ªé€™äº›äº‹æƒ…å°±èŠ±äº†è‡³å°‘ 10 åˆ†é˜ï¼ˆé‚„ä¸åŒ…å«å»ºç½®å‰è¦åšçš„ç‰ˆæœ¬ç®¡ç†ï¼‰ã€‚å¦‚æœåœ¨é–‹ç™¼éšæ®µéœ€è¦é »ç¹çš„é‡‹å‡ºç‰ˆæœ¬ï¼Œå¯èƒ½å°±è¦æ¯”å¹³å¸¸æ™šåŠå°æ™‚ï¼Œç”šè‡³ä¸€å°æ™‚æ‰èƒ½ä¸‹ç­å•Š ğŸ˜–

## è¦åŠƒæ›´ç‰ˆæµç¨‹

{% blockquote %}
ç•¶ä½ ç™¼ç¾åŒä¸€ä»¶äº‹æƒ…åšäº†ä¸‰æ¬¡ä»¥ä¸Šï¼Œæœªä¾†ä¹Ÿæœƒç¹¼çºŒåšæ™‚ï¼Œå°±å…ˆåœä¸‹ä¾†å§ï¼
{% endblockquote %}

æ‰‹å‹•åšé€™äº›äº‹æƒ…ï¼Œé™¤äº†æµªè²»æ™‚é–“ä»¥å¤–ï¼Œä¹Ÿå¾ˆå®¹æ˜“å¢åŠ å‡ºéŒ¯çš„æ©Ÿç‡ã€‚ä¾‹å¦‚ä¸Šå‚³åˆ°éŒ¯çš„æª”æ¡ˆã€ç‰ˆæœ¬æ¨™éŒ¯ç­‰ã€‚å› æ­¤ï¼Œæˆ‘å€‘éœ€è¦ä»°è³´å·¥å…·ï¼Œå¹«æˆ‘å€‘åšé€™äº›åƒç¯‡ä¸€å¾‹çš„ä»»å‹™ï¼Œè®“çœä¸‹ä¾†çš„æ™‚é–“ï¼Œå»åšæœ‰å¯¦éš›ç”¢å‡ºã€æœ‰å‰µé€ åŠ›çš„äº‹ ğŸ’ª

é¦–å…ˆï¼Œå¿…é ˆå…ˆæ•´ç†å‡ºè¦éœ€è¦å“ªäº›ä»»å‹™ï¼Œé€™äº›ä»»å‹™çš„å‰å¾Œé—œä¿‚ï¼Œä»¥åŠæ€è€ƒæ¯å€‹ä»»å‹™çš„åŸ·è¡Œå…§å®¹ã€‚é€™éƒ¨åˆ†æœƒæ ¹æ“šé–‹ç™¼ç¿’æ…£ã€å°ˆæ¡ˆæ€§è³ªã€ç”¢å“é–‹ç™¼éšæ®µçš„ä¸åŒè€Œæœƒæœ‰ä¸ä¸€æ¨£çš„æµç¨‹ã€‚åªè¦æœ‰æƒ³æ¸…æ¥šå°±å¥½ï¼Œæ²’æœ‰ä¸€å®šçš„æ¨™æº–ã€‚

![è¦åŠƒæ›´ç‰ˆçš„æµç¨‹](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig1.png)

ä»¥æˆ‘ç›®å‰æ¥æ‰‹çš„å°ˆæ¡ˆä¾†èªªï¼Œéœ€è¦åšçš„æ˜¯å»ºç½®é›™ç³»çµ±çš„é–‹ç™¼ç‰ˆ App çµ¦å…§éƒ¨äººå“¡ã€‚æ‰€ä»¥å°±è¦åŠƒäº†ä»¥ä¸Šæµç¨‹ã€‚å·¥å…·ä¸Šï¼Œæˆ‘ä¸»è¦æœƒç”¨ä»¥ä¸‹å…©ç¨®ï¼š

- **[Conventional Changelog](https://github.com/conventional-changelog/conventional-changelog)**: ç‚º commit å¢åŠ åˆ†é¡ã€æè¿°ã€é—œè¯çš„ issue ç­‰æ ¼å¼åŒ–è¨Šæ¯ï¼Œä¸¦ç”¢å‡º CHANGELOG.md  
  
  å‰ç½®æº–å‚™-

  1. åœ¨å…¨åŸŸå®‰è£ commitizen è·Ÿ conventional-changelog-cli
     `npm i -g commitizen conventional-changelog-cli`
  2. åœ¨å°ˆæ¡ˆç›®éŒ„ä¸‹å®‰è£ cz-conventional-changelog
     `npm i -D cz-conventional-changelog`
     å®‰è£å®Œæˆå¾Œï¼Œpackage.json æœƒè‡ªå‹•åŠ ä¸Šä¸€æ®µè¨­å®š
     {% codeblock package.json lang:json %}
     "config": {
        "commitizen": {
          "path": "./App4/node_modules/cz-conventional-changelog"
        }
     }
     {% endcodeblock %}

- **[fastlane](https://fastlane.tools/)**: æä¾›å¤§é‡å¯¦ç”¨çš„ actions å’Œ pluginsï¼Œä»¥ ruby code å’Œ cli åšåˆ°ä»»å‹™çš„è‡ªå‹•åŒ– 

  å‰ç½®æº–å‚™-
  1. å¯ä»¥åƒè€ƒ React Native Boilerplate Docs çš„[Installing Fastlane](https://thecodingmachine.github.io/react-native-boilerplate/docs/BetaBuild/#installing-fastlane)ã€‚é‡é»æ˜¯è¦å…ˆæœ‰ MacOSğŸ˜…
  2. åœ¨ ios è·Ÿ android çš„ç›®éŒ„ä¸‹åŸ·è¡Œ `fastlane init`ã€‚å…©å€‹ç³»çµ±åœ¨ setup æ™‚æœ‰äº›è¨±å·®ç•°ï¼ŒåŒæ¨£å¯ä»¥åƒè€ƒä¸Šé¢é€£çµã€‚
  3. éœ€è¦å®‰è£æŸå€‹ plugin æ™‚ï¼ŒåŸ·è¡Œ `fastlane add_plugin xxx` å°±å¯ä»¥å›‰ï¼
  4. æƒ³æŸ¥è©¢æŸå€‹å…§å»º action æˆ–æ˜¯ plugin æ™‚ï¼Œå¯ä»¥åŸ·è¡Œ `fastlane action xxx`ï¼Œå°±å¯ä»¥åœ¨command lineä¸Šçœ‹åˆ°å¾ˆæ¸…æ¥šçš„èªªæ˜æ–‡ä»¶ã€‚

æ¥ä¸‹ä¾†å°±é‡å°æ¯å€‹ä»»å‹™ä¾†åˆ†äº«æˆ‘çš„å¯¦ä½œæ–¹å¼å§ï¼

## ä»»å‹™å¯¦ä½œ

### æäº¤ commit

å¯«ä¸€ä»½å¥½çš„çš„commitï¼Œæœƒå¹«åŠ©æˆ‘å€‘å®Œæˆä»¥ä¸‹äº‹æƒ…ï¼š

- æ›´é †æš¢åœ° code review
- åœ˜éšŠåˆä½œçš„ç‰ˆæœ¬æ§ç®¡ï¼Œè®“å¤§å®¶ä¸€çœ‹å°±çŸ¥é“é‚£æ®µæ™‚é–“åœ¨åšä»€éº¼
- æ–¹ä¾¿æº–å‚™ release ç›¸é—œæ–‡ä»¶(e.g. ç”¢ç”ŸCHANGELOG.md)
- æä¾› trace code çš„ç·šç´¢

ç‚ºäº†æ–¹ä¾¿æ“ä½œï¼Œæˆ‘å€‘å¯ä»¥å»ºç«‹npmæŒ‡ä»¤

{% codeblock package.json lang:json %}
"script": {
  "cm": "npx cz",
}
{% endcodeblock %}

å°‡æƒ³è®Šæ›´çš„æª”æ¡ˆåŠ åˆ°stageï¼ŒåŸ·è¡Œ `npm run cm` å¾Œå°±å¯ä»¥é¡¯ç¤ºä»¥ä¸‹ç•«é¢ï¼š
![åˆå§‹ç•«é¢](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig6.png)

æ¥è‘—æŒ‰ç…§æ¯å€‹æ­¥é©Ÿå¡«å…¥åˆ†é¡ã€ç°¡è¿°ã€issueåºè™Ÿç­‰ï¼Œå°±å¯ä»¥å®Œæˆä¸€å€‹æœ‰å®Œæ•´è³‡è¨Šçš„commitå›‰ï¼

### æ›´æ–°ç‰ˆæœ¬

ç„¡è«–æ˜¯ Android é‚„æ˜¯ iOSï¼Œéƒ½æœƒæœ‰å…©å€‹å€¼å»æè¿°ç‰ˆæœ¬ã€‚ç”±æ–¼å…©é‚Šçš„åç¨±éƒ½ä¸å¤ªä¸€æ¨£ï¼Œæˆ‘é€™è£¡å°±å–ä¸€è‡´çš„ä¸­æ–‡åç¨±ã€‚

- ç‰ˆåï¼šå»ºè­°æ¡[Semantic Versioning](https://semver.org/lang/zh-TW/)(major.minor.patch)ã€‚ ä¸»è¦ç”¨é€”æ˜¯åœ¨ä¸Šæ¶å•†åº—ä¸­æœƒé¡¯ç¤ºçµ¦ä½¿ç”¨è€…çœ‹ã€‚

  |  | iOS | Android |
  | --- | --- | --- |
  | åç¨± | Version Number | Version Name |
  | æ ¼å¼ | å»ºè­° Semantic Versioning  | åŒå·¦ |

- ç‰ˆè™Ÿï¼šå»ºç½®è™Ÿç¢¼ï¼Œä¸»è¦ç”¨é€”æ˜¯çµ¦å•†åº—çš„ä¸Šæ¶ç³»çµ±è­˜åˆ¥ä½¿ç”¨ï¼Œä¸¦ä¸æœƒçµ¦ä½¿ç”¨è€…çŸ¥é“ã€‚æ­¤å¤–ï¼Œåœ¨å…©å€‹ä½œæ¥­ç³»çµ±ä¸­ï¼Œå»ºç½®è™Ÿç¢¼çš„è¦å‰‡ä¹Ÿä¸å¤ªä¸€æ¨£ã€‚

  |  | iOS | Android |
  | --- | --- | --- |
  | æ ¼å¼ | å»ºè­° Semantic Versioning | é ˆç‚ºæ•¸å­— |
  | è¦å‰‡ | åŒç‰ˆåä¸­ä¸èƒ½é‡è¤‡ï¼Œä¸åŒç‰ˆåé–“å¯ä»¥é‡è¤‡  | ç„¡è«–ç‰ˆåå¿…é ˆå¾€ä¸Šéå¢ |
  | é™åˆ¶ | ç„¡ç‰¹å®šæ ¼å¼é™åˆ¶ | ä¸èƒ½è¶…é**2100000000** |

ç‚ºäº†ç®¡ç†æ–¹ä¾¿ï¼Œæˆ‘é€™è£¡æ¡é›™ç³»çµ±çš†å–ä¸€è‡´çš„ç‰ˆåè·Ÿç‰ˆè™Ÿã€‚ç‰ˆåçš„è©±å°±ä¾ `package.json` çš„ `version` è€Œå®šï¼›ç‰ˆè™Ÿçš„è©±å›  Android çš„é™åˆ¶æ¯”è¼ƒå¤šï¼Œæ‰€ä»¥å°±ä»¥ Android çš„å‘½åè¦å‰‡ä¾†å–ç‰ˆè™Ÿã€‚

ç‰ˆè™Ÿé‚è¼¯å¯ä»¥æ ¹æ“šå–œå¥½æˆ–ç¶­è­·æ–¹ä¾¿è€Œå®šã€‚è€Œæˆ‘è¨‚çš„ç‰ˆè™Ÿè¦å‰‡æ˜¯ï¼š

1. å›ºå®šå…«ä½æ•¸ï¼Œæ ¼å¼ç‚º **yymmddnn**
   - yyï¼šå¹´ä»½çš„å¾Œå…©ä½æ•¸
   - mmï¼šæœˆä»½ï¼Œå›ºå®šå…©ä½æ•¸
   - ddï¼šæ—¥æœŸï¼Œå›ºå®šå…©ä½æ•¸
   - nnï¼šå»ºç½®åºè™Ÿï¼Œå›ºå®šå…©ä½æ•¸
2. åŒå€‹æ—¥æœŸå°±æŠŠå»ºç½®åºè™Ÿå¾ 00 å¾€ä¸Šéå¢
3. ä¸åŒæ—¥æœŸå°±æŠŠå»ºç½®åºè™Ÿæ­¸ç‚º 00

åœ¨ fastlane ä¸­ï¼ŒiOS çš„ç‰ˆåè·Ÿç‰ˆè™Ÿéƒ½æœ‰å…§å»ºçš„ action å¯ä»¥è®€å¯«ï¼›ä¸é Android çš„éƒ¨åˆ†å°±è¦å¦å¤–å®‰è£ pluginã€‚

| ç‰ˆå | iOS | Android |
| --- | --- | --- |
| è®€ | `get_version_number` | `get_version_name` |
| å¯« | `increment_version_number`  | `increment_version_name` |

| ç‰ˆè™Ÿ | iOS | Android |
| --- | --- | --- |
| è®€ | `get_build_number` | `get_version_code` |
| å¯« | `increment_build_number`  | `increment_version_code` |

ç‰ˆåå› ç‚ºéœ€è¦å–å¾—`package.json`ï¼Œæ‰€ä»¥æˆ‘å€‘éœ€è¦å®‰è£ plugin `load_json`ã€‚

```ruby
package = load_json(json_path: "../package.json")
curr_build_number = get_build_number().to_i
datetime_number = Time.new.strftime('%Y%m%d')[2, 6].to_i * 100
diff = curr_build_number - datetime_number
new_build_number = 0;
if diff >= 0 # same day
  new_build_number = datetime_number + diff + 1
else # another day
  new_build_number = datetime_number
end
increment_build_number(
  build_number: new_build_number
)
```

### æ‰“ç‰ˆæœ¬ tag

ä»¥æˆ‘çš„éœ€æ±‚ä¾†èªªï¼Œå¸Œæœ›æ¯æ¬¡çš„æ›´ç‰ˆåœ¨ git ä¸Šç•™ä¸‹ç´€éŒ„ã€‚å› æ­¤æˆ‘æœƒæŠŠç‰ˆååŠ ä¸Šç‰ˆè™Ÿçµ„æˆä¸€å€‹å®Œæ•´çš„ç‰ˆæœ¬åç¨±ï¼Œæ¥è‘—åœ¨æ‰“åˆ° git tag ä¸Šã€‚

éœ€è¦ä½¿ç”¨çš„ action æœ‰ [add_git_tag](https://docs.fastlane.tools/actions/add_git_tag/)ã€‚

```ruby
package = load_json(json_path: "../package.json")
version_name = package['version']
version_code = get_version_code()
add_git_tag(
  tag: "v" + version_name + "-" + version_code
)
```

### å»ºç½®å®‰è£æª”

Android ä¸­çš„å»ºç½®éšæ®µéå¸¸ç°¡å–®ï¼Œä¸éœ€è¦ä»»ä½•çš„é©—è­‰æˆ–è¨­å®šï¼Œåªéœ€è¦çŸ¥é“é€™æ¬¡è¦å»ºç½®çš„æ˜¯ Debug ç‰ˆæˆ–æ˜¯ Release ç‰ˆå°±å¥½ã€‚

{% codeblock Android lang:ruby %}
# ç›¸ç•¶æ–¼åŸ·è¡Œ gradlew clean && gradlew assembleDebug
gradle(task: "clean assembleDebug")
{% endcodeblock %}

iOS çš„å°±æ¯”è¼ƒéº»ç…©ï¼Œå¥½åœ¨ fastlane æœ‰æä¾›ä»‹é¢ç›¸å°å‹å–„çš„å¥—ä»¶-[gym](http://docs.fastlane.tools/actions/build_app/#usage)ã€‚æˆ‘å€‘å¯ä»¥ä½¿ç”¨ `build_app` é€™å€‹ action ä¾†å®Œæˆå»ºç½®çš„è¨­å®šã€‚

{% codeblock iOS lang:ruby %}
build_app(
  silent: true,
  clean: true,
  configuration: "Release",  
  scheme: "AppName",
  output_name: "app.ipa",
  export_options: {
    # æŒ‡å®šéƒ¨ç½²æ–¹å¼
    method: "enterprise",
    # æŒ‡å®š provision profile
    provisioningProfiles: {
      "app.bundle.indentifier" => "ProvisionProfileName",
    }
  }
)
{% endcodeblock %}

### ä¸Šå‚³è‡³ Dropbox

ç”¢ç”Ÿå®‰è£æª”å¾Œï¼Œæˆ‘å€‘æ˜¯é¸æ“‡ä»¥ OTA æ–¹å¼ï¼Œå°‡å®‰è£æª”æ”¾åœ¨é›²ç©ºé–“ä¾›æ¸¬è©¦äººå“¡ä¸‹è¼‰ã€‚å¦‚ä½•å»ºç«‹ OTA çš„å®‰è£æ©Ÿåˆ¶ï¼Œå¯ä»¥åƒè€ƒ[é€™ç¯‡æ–‡ç« ](https://wenrongdev.com/install-ipa-with-ota/)ã€‚

ä»¥ Dropbox ç•¶ä½œé›²ç©ºé–“çš„è©±ï¼Œè¨­å®šçš„é‡é»æœ‰ä»¥ä¸‹ï¼š

1. åœ¨ [Dropbox Developers](https://www.dropbox.com/developers/apps) å»ºç«‹æ‡‰ç”¨ï¼Œç„¶å¾Œå–å¾— **token**ã€‚è¦æ³¨æ„çš„åœ°æ–¹æœ‰ä»¥ä¸‹ï¼š
    - token çš„æœŸé™è¦è¨­ç‚º `No expiration`ï¼Œä¸ç„¶é è¨­ 15 åˆ†å¾Œå°±æœƒåˆ°æœŸã€‚
    ![Settings > OAuth2 è¨­å®š token](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig4.png)
    - éœ€è¦æ‰“é–‹æª”æ¡ˆçš„ç·¨è¼¯æ¬Šé™ `file.content.write`
    ![Permissions > Individual Scopes > Files and folders](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig5.png)
2. åƒè€ƒ fastlane çš„[é€™ä»½æ–‡ä»¶](https://docs.fastlane.tools/best-practices/keys/)ï¼Œå°‡ token é€™ç¨®æ©Ÿæ•è³‡è¨Šå¦¥å–„ç®¡ç†ã€‚æˆ‘é€™è£¡æ˜¯ä½¿ç”¨ [dotenv](https://github.com/bkeepers/dotenv)ï¼Œå¥½è™•æ˜¯ä¸ç”¨æ›´æ”¹æœ¬æ©Ÿçš„ç’°å¢ƒè®Šæ•¸ï¼Œé€é `gitignore` æ–¹å¼å°‡æ©Ÿæ•æª”æ¡ˆéæ¿¾æ‰ã€‚
   - åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹åŸ·è¡Œ `gem install dotenv` å®‰è£
   - åœ¨å°ˆæ¡ˆæ ¹ç›®éŒ„ä¸‹æ–°å¢ `.env.secret`
     {% codeblock .env.secret lang:js %}
      DROPBOX_OAUTH_TOKEN="xxx..."
     {% endcodeblock %}

   - åœ¨ Fastfile ä¸­å¼•å…¥ dotenv è·Ÿ å‰›å‰›å»ºç«‹çš„ `.env.secret`
     {% codeblock Fastfile lang:ruby %}
      fastlane_require 'dotenv'

      before_all do
        Dotenv.overload '../../.env.secret'
      end
     {% endcodeblock %}

3. å®‰è£ [fastlane-plugin-dropbox](https://github.com/ayoy/fastlane-plugin-dropbox)ã€‚æ¬„ä½çš„æ³¨æ„äº‹é …æœ‰ä»¥ä¸‹ï¼š
   - `write_mode`-å¯«å…¥çš„æ¨¡å¼ï¼Œæ–‡ä»¶ä¸Šæœ‰å¯«æ¯”è¼ƒç†æƒ³çš„æ–¹å¼æ˜¯`update`ï¼Œä¸éé‚„æ²’å¼„æ¸…æ¥š `update_rev` è¦å¦‚ä½•è¨­å®šï¼Œæ‰€ä»¥ç›®å‰æ¸¬è©¦ï¼¯ï¼«çš„æ˜¯`overwrite`
   - `file_path`-è¦ä½¿ç”¨å®‰è£æª”çš„çµ•å°è·¯å¾‘
   - `dropbox_path`-ä¸­æ–‡åç¨±ä¹Ÿï¼¯ï¼«ã€‚æ²’æœ‰é€™å€‹æ¬„ä½çš„è©±é è¨­æ˜¯ä¸Šå‚³åˆ°æ ¹ç›®éŒ„
   - `access_token`-ä»¥ `ENV[name]` ä¾†å–å¾—å‰›å‰›åœ¨ `.env.secret` å»ºç«‹çš„ token å€¼
  ```ruby
  dropbox(
    write_mode: 'overwrite',
    file_path: '/Users/sss/xxx/ooo/ios/app.ipa',
    dropbox_path: 'ç¬¬ä¸€å±¤ç›®éŒ„åç¨±/ç¬¬äºŒå±¤ç›®éŒ„åç¨±',
    access_token: ENV['DROPBOX_OAUTH_TOKEN']
  )
  ```

### é€šçŸ¥å·¥ä½œç¾¤çµ„

ç•¶å®‰è£æª”å»ºç½®å®Œæˆã€ä¸Šå‚³åˆ°é›²ç©ºé–“å¾Œï¼Œç›¸é—œäººå“¡å°±å¯ä»¥å‰å¾€æ›´æ–°ç‰ˆæœ¬äº†ã€‚å¦‚æœåœ˜éšŠä¸­æœ‰ä½¿ç”¨æœƒè©±ç¾¤çµ„ï¼Œåƒæ˜¯ slack ã€ google chat ç­‰ï¼Œfastlane æœ‰æä¾›ç›¸é—œçš„ plugin ä¾†å¹«æˆ‘å€‘åšåˆ°ä¸»å‹•é€šçŸ¥çš„äº‹æƒ…ã€‚

1. é¦–å…ˆå®‰è£ [fastlane-plugin-google_chat](https://github.com/narlei/fastlane-plugin-google-chat) 
   `fastlane add_plugin google_chat`
2. åœ¨æœƒè©±ç¾¤çµ„çš„èŠå¤©å®¤åç¨±ï¼Œå³é‚Šæœ‰å€‹å°ä¸‰è§’å½¢ï¼Œé»é¸å¾Œé¸æ“‡ã€Œç®¡ç† Webhookã€
3. ä¸€é–‹å§‹å¦‚æœæ²’æœ‰è¨­å®š webhookï¼Œæœƒç›´æ¥è®“ä½ è¼¸å…¥åç¨±è·Ÿåœ–ç‰‡ç¶²å€ã€‚
   åç¨±å¯ä»¥è¼¸å…¥ fastlaneï¼Œä¹‹å¾Œæ–°å¢å…¶ä»–çš„æœå‹™é€£å‹•ï¼Œæœƒæ¯”è¼ƒæ¸…æ¥šæ˜¯å“ªå€‹ä¾†æºæ‰“çš„ã€‚
   åœ–ç‰‡ç¶²å€å¯ä»¥ä¸è¨­ï¼Œä¹Ÿå¯ä»¥å–æ‰¾å°æ‡‰çš„iconç¶²å€å¡«å…¥ã€‚
4. é»é¸ã€Œå„²å­˜ã€å¾Œå°±å¯ä»¥ç”¢ç”Ÿä¸¦å–å¾— Webhook çš„é€£çµå›‰ï¼

![åœ¨ Google Chat è¨­å®šä¸¦å–å¾— Webhook](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig2.png)

æœ€å¾Œï¼Œåƒè€ƒä½œè€…çš„[ç¯„ä¾‹](https://github.com/narlei/fastlane-plugin-google-chat/blob/00b7dbf3dc144e642f05e77879d6a3009c1cf318/fastlane/Fastfile)ä¿®æ”¹å°±ï¼¯ï¼«äº†ã€‚

```ruby
package = load_json(json_path: "../package.json")
curr_build_number = get_build_number()

google_chat(
    imageUrl: 'https://xxx.ooo.png',
    webhook: 'https://chat.googleapis.com/v1/spaces/xxx/messages?key=ooo&token=jjj',
    title: 'ZZZ App é–‹ç™¼ç‰ˆ',
    description: 'Android Debug / iOS Enterprise å·²æ›´æ–°ï¼Œè«‹å‰å¾€ä¸‹è¼‰å®‰è£ï¼',
    section1Title: 'Version',
    section1Description: "v" + package["version"] + "-" + curr_build_number,
    buttonTitle: "é–‹å•Ÿä¸‹è¼‰å®‰è£é ",
    buttonUrl: "https://fff.com"
)
```

![è¨Šæ¯é€šçŸ¥çš„é¡¯ç¤º](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig3.png)

### åŸ·è¡Œ fastlane ä»»å‹™

ä¸Šé¢é€™äº› fastlane çš„ä»»å‹™ï¼Œè¦æ€éº¼ä¸²é€£èµ·ä¾†å‘¢ï¼Ÿ

é€šå¸¸æˆ‘å€‘æœƒæŠŠé€™äº›å–®ä¸€ä»»å‹™åˆ†åˆ¥ç”¨ `private_lane`åŒ…è¦†èµ·ä¾†ï¼Œè¡¨ç¤ºé€™æ˜¯ä¸èƒ½å–®ç¨åŸ·è¡Œçš„ã€‚æ¥è‘—å†æ–°å¢ä¸€å€‹ç”¨ `lane`åŒ…è¦†èµ·ä¾†çš„ä»»å‹™ï¼Œå·¥ä½œå…§å®¹å°±æ˜¯ä¾åºåŸ·è¡Œé€™äº›ç§æœ‰ä»»å‹™ã€‚

private_lane çš„å¯«æ³•ï¼š

```ruby
desc "Android Debug: Build a Debug App"
  private_lane :debug_build do
    gradle(task: "clean assembleDebug")
  end
```

åœ¨ Android è£¡çš„ lane

{% codeblock Android lang:ruby %}
desc "Android Debug: Do all jobs"
  lane :debug_jobs do
    version_code
    version_name
    git_version_tag
    debug_build
    debug_upload
  end
{% endcodeblock %}

åœ¨ iOS è£¡çš„ lane

{% codeblock iOS lang:ruby %}
desc "iOS Enterprise: Do all jobs"
  lane :enterprise_jobs do
    build_number
    version
    enterprise_archive
    enterprise_upload
    notify_chat
  end
{% endcodeblock %}

ç‚ºäº†æ›´æ–¹ä¾¿åŸ·è¡ŒæŒ‡ä»¤ï¼Œå¯ä»¥æ–°å¢npmæŒ‡ä»¤ã€‚

æœ‰å€‹é¡Œå¤–è©±ï¼Œæˆ‘åœ¨åˆ‡åˆ° ios çš„ç›®éŒ„å¾Œï¼ŒåŸ·è¡Œ fastlane çš„å‰ç¶´æœ‰åŠ  `arch -x86_64`ï¼ŒåŸå› æ˜¯æˆ‘ç›®å‰ä½¿ç”¨ Mac m1ï¼Œå› ç‚ºç¡¬é«”ä¸Šçš„é™åˆ¶æ‰éœ€è¦åŠ ã€‚å¦‚æœä¹‹å¾Œåœ¨å®‰è£ä»€éº¼æˆ–åŸ·è¡Œä»€éº¼æ™‚ç™¼ç”Ÿæ„å¤–éŒ¯èª¤ï¼Œå¯ä»¥è©¦è‘—åŠ åŠ çœ‹ã€‚ 

```json
"scripts": {
    "dist-dev-app": "cd android && fastlane debug_jobs && cd .. && cd ios && arch -x86_64 fastlane enterprise_jobs && cd ..",
}
```

### æ›´æ–° CHANGELOG.md

æœ€å¾Œï¼Œå°±æ˜¯ç”¢å‡º CHANGELOG.mdï¼Œä¸¦æ›´æ–°åˆ° git ä¸Šå›‰ï¼

åŒæ¨£æˆ‘å€‘å¯ä»¥ç‚ºå†—é•·çš„ cli æ–°å¢ npm æŒ‡ä»¤ï¼š

```json
"scripts": {
    "cg": "conventional-changelog -p angular -i CHANGELOG.md -s -r 0 && git commit -am CHANGELOG.md"
}
```

![CHANGELOG.md](/%E8%BB%9F%E9%AB%94%E9%96%8B%E7%99%BC/2021041514/fig7.png)

## çµè«–

åœ¨å°å…¥é€™äº›å·¥å…·æ™‚ï¼Œå…¶å¯¦ä¸åˆ°åŠå¤©çš„æ™‚é–“å°±å¯ä»¥å®Œæˆäº†ã€‚å­¸ç¿’é–€æª»ä¾†èªªï¼Œä¹Ÿä¸ç”¨å¤ªé«˜ï¼Œé ‚å¤šåªéœ€è¦æŸ¥è©¢ä¸€äº› ruby çš„åŸºæœ¬èªæ³•ç­‰ï¼Œç®—æ˜¯å¾ˆå€¼å¾—ä¸Šæ‰‹çš„å·¥å…·ã€‚
æ¯”è¼ƒé‡è¦çš„æ˜¯è¦æ€è€ƒä»»å‹™çš„å®‰æ’åˆä¸åˆç†ï¼Œåœ¨è‡ªå‹•åŒ–å’Œå¾ŒçºŒç¶­è­·ä¸Šæ˜¯ä¸æ˜¯å¯ä»¥æ›´é †æš¢ï¼›å¦å¤–åœ¨éƒ¨ç½²ä¸Šæ¶ç‰ˆçš„æµç¨‹å’Œè·Ÿé–‹ç™¼éšæ®µçš„æµç¨‹å‹¢å¿…æœƒä¸å¤ªä¸€æ¨£ã€‚åˆ°æ™‚å€™æœ‰ä»€éº¼æ–°æƒ³æ³•ï¼Œå†è·Ÿå¤§å®¶åˆ†äº«å›‰ ğŸ‘‹
